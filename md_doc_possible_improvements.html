<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPI-AMRVAC: Suggestions and improvements</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MPI-AMRVAC
   &#160;<span id="projectnumber">3.0</span>
   </div>
   <div id="projectbrief">The MPI - Adaptive Mesh Refinement - Versatile Advection Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Suggestions and improvements </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The suggestions and/or improvements below are collecting some views. Please change/update this list according to your own ideas.</p>
<h1>Improvements or suggestions</h1>
<h3>Hybrid OpenMP/MPI</h3>
<p>Scattered throughout the code there are OpenMP statements. Is the potential performance gain worth it? And more importantly, do we have the debugging and maintenance manpower to handle hybrid MPI/OpenMP?</p>
<p>Some literature on hybrid MPI/OpenMP vs pure MPI performance:</p>
<p><a href="http://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=1302919">link</a> <em>hybrid models are not efficiently supported by existing MPI implementations, resulting to an imbalanced message passing that is performed solely by the master thread.</em></p>
<p><a href="http://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=4912964">link</a> <em>Mismatch problems, i.e. the unsuitability of current hybrid hardware for running highly parallel workloads, are often hard to solve, let alone in a portable way. However, the potential gains in scalability and absolute performance may be worth the significant coding effort.</em></p>
<p><a href="https://goparallel.sourceforge.net/openmp-vs-mpi-better/">link</a> <em>The paper indicated that there can be significant improvements with a hybrid approach but found that the older memory model used in OpenMP reduces performance.</em></p>
<p><a href="https://computation.llnl.gov/casc/people/chow/pubs/hpaper.pdf">link</a> <em>summary: hybrid not advantageous now, may change in future</em></p>
<p><a href="https://www.epcc.ed.ac.uk/sites/default/files/PDF/mixedMode3.pdf">link</a> <em>results indicate that performance portability of mixed OpenMP/MPI programs is likely to be a significant issue on current systems: different implementations have widely differing performance characteristics</em></p>
<h2>Code standards</h2>
<p>New modelers can learn best practices from the MPI-AMRVAC code. Perhaps we can bundle a style guide with MPI-AMRVAC and try to adhere to it when we add or change code. Here are already some links to already existing Fortran style guides and best practices:</p>
<ul>
<li><a href="http://www.fortran90.org/src/best-practices.html">http://www.fortran90.org/src/best-practices.html</a></li>
<li><a href="http://www.fortran.com/Fortran_Style.pdf">http://www.fortran.com/Fortran_Style.pdf</a></li>
<li><a href="http://research.metoffice.gov.uk/research/nwp/numerical/fortran90/f90_standards.html">http://research.metoffice.gov.uk/research/nwp/numerical/fortran90/f90_standards.html</a></li>
<li><a href="https://github.com/Fortran-FOSS-Programmers/Best_Practices">https://github.com/Fortran-FOSS-Programmers/Best_Practices</a></li>
</ul>
<p>We could also think about more general coding practices (not Fortan-specific), for example:</p>
<ul>
<li>Clear purpose. For example, it should be clear what the physics modules can be used for, and what their limitations are.</li>
<li>Robustness: the code should not fail on valid input, and should return meaningful error messages. Crashes without error messages should be prevented.</li>
<li>Maintainability: code should be as easy to maintain as possible, which means code should be simple (or as simple as possible), testable and documented.</li>
</ul>
<h2>Limit the usage of the preprocessor</h2>
<p>The advantages of the <b>VACPP</b> preprocessor are outlined in <a href="http://www-personal.umich.edu/~gtoth/Papers/lasy.html">this paper</a>:</p>
<ul>
<li>Compact code</li>
<li>No separate 2D and 3D versions (which can lead to bugs)</li>
<li>Efficiency (no complicated abstractions)</li>
</ul>
<p>However, extensive usage of a preprocessor also has a major drawback: <b>the code is more complicated to understand</b>. The project's entry barrier is also increased, because knowing the programming language (in this case Fortran) is not enough &ndash; one also has to learn the preprocessor language.</p>
<p>Take for example the following lines and their expansion in 3D:</p>
<div class="fragment"><div class="line">pflux(iside,^D,igrid)%flux(1^D%:^DD&amp;,1:nwflux) = &amp;</div>
<div class="line">                  fC(ixMhi^D^D%ixM^T,1:nwflux,^D)</div>
<div class="line"> </div>
<div class="line">pflux(iside,1,2,3,igrid)%flux(1,:,:,:,1,:,:,:,1,1:nwflux) = fC(ixMhi1,&amp;</div>
<div class="line">   ixMlo2:ixMhi2,ixMlo3:ixMhi3,ixMlo1:ixMhi1,ixMhi2,ixMlo3:ixMhi3,&amp;</div>
<div class="line">   ixMlo1:ixMhi1,ixMlo2:ixMhi2,ixMhi3,1:nwflux,1,2,3)</div>
</div><!-- fragment --><div class="fragment"><div class="line">itag=4**^ND*(ineighbor-1)+{inc^DD*4**(^DD-1)+}</div>
<div class="line"> </div>
<div class="line">itag=4**3*(ineighbor-1)+inc1*4**(1-1)+inc1*4**(1-1)+inc1*4**(1&amp;</div>
<div class="line">   -1),itag=4**3*(ineighbor-1)+inc2*4**(2-1)+inc2*4**(2-1)+inc2*4**(2&amp;</div>
<div class="line">   -1),itag=4**3*(ineighbor-1)+inc3*4**(3-1)+inc3*4**(3-1)+inc3*4**(3-1)</div>
</div><!-- fragment --><p>For the next example the surrounding braces have been omitted because they broke the markdown formatting:</p>
<div class="fragment"><div class="line">do ic^DDB=1+int((1-i^DDB)/2),2-int((1+i^DDB)/2)</div>
<div class="line">inc^DDB=2*i^DDB+ic^DDB</div>
<div class="line"> </div>
<div class="line">do ic3=1+int((1-i3)/2),ic2=1+int((1-i2)/2),ic1=1&amp;</div>
<div class="line">   +int((1-i1)/2),2-int((1+i3,1+i2,1+i1)/2)</div>
<div class="line">inc3=2*i3+ic3,inc2=2*i2+ic2,inc1=2*i1+ic1</div>
<div class="line">do ic3=1+int((1-i3)/2),ic2=1+int((1-i2)/2),ic1=1&amp;</div>
<div class="line">   +int((1-i1)/2),2-int((1+i3,1+i2,1+i1)/2)</div>
<div class="line">inc3=2*i3+ic3,inc2=2*i2+ic2,inc1=2*i1+ic1</div>
<div class="line">do ic3=1+int((1-i3)/2),ic2=1+int((1-i2)/2),ic1=1&amp;</div>
<div class="line">   +int((1-i1)/2),2-int((1+i3,1+i2,1+i1)/2)</div>
<div class="line">inc3=2*i3+ic3,inc2=2*i2+ic2,inc1=2*i1+ic1</div>
</div><!-- fragment --><p>Such expressions are quite difficult to understand. Note also the lack of spacing and indentation in the expanded versions.</p>
<p>Therefore, we minimize the usage of <em>complicated preprocessor patterns</em> in new code. (Of course, <em>complicated</em> is subjective here.) With human intelligence, many complicated patterns can probably be avoided. In cases where the power of the preprocessor is really needed, we suggest adding a comment explaining what is done.</p>
<h3>Current usage of preprocessor</h3>
<p>The following command sequence will show you the current usage of the preprocessor flags. </p><pre class="fragment">cd src

# grep options: -E extended regex, -o only matching, -h no file names
# sort &amp; uniq -c create a histogram
grep -E -o -h "\^[A-Z]+" *.t */*.t -R | sort | uniq -c | sort -nr
</pre> <h2>Output file formats</h2>
<p>The VTK unstructured file format does not scale well to large 3D simulations, see <a href="http://scicomp.stackexchange.com/questions/23657/visualization-of-quadtree-octree-grids">this link</a>. With <em>large</em> we mean for example ten million cells or more. In any case, the VTK unstructured format is much more general than we need for our hyperoctree (or orthtree) meshes.</p>
<p>Somebody could look into alternatives, which will probably require collaboration with Paraview/VTK developers. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
